---
- name: Check application health endpoint
  uri:
    url: http://localhost:3000/health
    method: GET
    return_content: yes
    status_code: 200
  register: health_check
  retries: 5
  delay: 3
  until: health_check.status == 200

- name: Display health check result
  debug:
    msg: "Application health check passed: {{ health_check.json }}"

- name: Create health check script
  copy:
    dest: /usr/local/bin/check-userapi-health.sh
    mode: '0755'
    content: |
      #!/bin/bash
      response=$(curl -s http://localhost:3000/health)
      if echo "$response" | grep -q "healthy"; then
        echo "✓ User API is healthy"
        exit 0
      else
        echo "✗ User API is not responding correctly"
        exit 1
      fi

- name: Create cron job for periodic health check
  cron:
    name: "User API Health Check"
    minute: "*/5"
    job: "/usr/local/bin/check-userapi-health.sh >> /var/log/userapi-health.log 2>&1"
